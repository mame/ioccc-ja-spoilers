---
id: 2001/westley
year: 2001
order: 13
authors: "Brian_Westley"
orig_url: "https://www.ioccc.org/2001/westley.c"
hint_url: "https://github.com/ioccc-src/winner/blob/main/2001/westley.hint"
title: "IOCCC 2001: Best position-independent code"
award_ja: "最高の位置独立コード"
---

## 動作

元プログラムの動作は、入力を行単位でランダムにシャッフルして表示する。

```
$ gcc -trigraphs -o westley westley.c

$ echo -e '1\n2\n3' | ./westley
1
3
2

$ echo -e '1\n2\n3' | ./westley
2
3
1

$ echo -e '1\n2\n3' | ./westley
2
1
3
```

元のソースコード自身をシャッフルしてもコンパイルできる。
そして、シャッフル結果に依存してさまざまな挙動をするプログラムになる（変わらない場合もある）。

次はただのcatになった例。

```
$ ./westley < westley.c > tmp.c

$ gcc -trigraphs -o tmp tmp.c

$ echo -e '2\n1\n3' | ./tmp
2
1
3
```

次は行反転コマンドになった例。

```
$ ./westley < westley.c > tmp.c

$ gcc -trigraphs -o tmp tmp.c

$ echo -e '1\n2\n3' | ./tmp
3
2
1
```

次はsortになった例。

```
$ ./westley < westley.c > tmp.c

$ gcc -trigraphs -o tmp tmp.c

$ echo -e '2\n1\n3' | ./tmp
1
2
3

$ echo -e '3\n2\n1' | ./tmp
1
2
3
```

そして、パンチカード風に出力するものになった例。

```
$ echo "Hello, world" | ./tmp
 _________________________________________________________________________________
/Hello, world                                                                    |
|[[[[[   [[[[                                                                    |
|  [[[  [[[[                                                                     |
| [   [ [   [                                                                    |
|                                                                                |
|                                                                                |
|  [[ [    [                                                                     |
|           [                                                                    |
| [                                                                              |
|    [  [[                                                                       |
|                                                                                |
|[    [                                                                          |
|         [                                                                      |
|________________________________________________________________________________|

$ echo '&-0123456789ABCDEFGHIJKLMNOPQR/STUVWXYZ:#@'"'"'=".<(+|./t*);,%_>?abcmnoxyz^[]{}\' | ./tmp
 _________________________________________________________________________________
/&-0123456789ABCDEFGHIJKLMNOPQR/STUVWXYZ:#@'=".<(+|./t*);,%_>?abcmnoxyz^[]{}\    |
|[           [[[[[[[[[                       [[[[[[[          [[[[[[   [[[[[[    |
| [                   [[[[[[[[[              [       [[[[        [[[[[[[[[[[[    |
|  [                           [[[[[[[[[     [      [[   [[[[ [[[   [[[[[[[[[    |
|   [        [        [        [             [      [         [        [[[[[[    |
|    [        [        [        [       [    [                 [       [[[[[[    |
|     [        [        [        [       [   [[    [ [   [      [      [[[[[[    |
|      [        [        [        [       [  [ [      [   [      [     [[[[[[    |
|       [        [        [        [       [ [  [      [   [      [    [[[[[[    |
|        [        [        [        [       [[   [      [   [      [   [[[[[[    |
|         [        [        [        [       [    [          [      [  [[[[[[    |
|          [        [        [        [ [[[[[[[[[[[[  [[[[[[[[       [ [[[[[[    |
|           [        [        [        [     [                        [[[[[[[    |
|________________________________________________________________________________|
```

## 解説

westley.cは空行やコメント行を除いて実質28行なので、その順列の数は28! = 304,888,344,611,713,860,501,504,000,000で、このいずれもビルド可能になっている。そして、挙動で分類すると12種類になる。12種類の内訳は組み合わせ。

* ベースの挙動：3種類（行の順序を変えない or シャッフルする or ソートする）
* 後処理の挙動：2種類（行の順序を変えない or 行の順序を反転する）
* 表示方法：2種類（テキストそのまま or パンチカード風）

組み合わせなので、ソートしつつ反転してパンチカード風に表示するコマンドも出てくることがある。

このコードの着想は、パンチカードの扱いにあるとのこと。
パンチカードの束をうっかり床に落とすと、順番がわからなくなって大変なことになる。
しかしC言語は行の順番を変えても意味が変わらないように書くことができる（落下耐性がある）ので便利、というネタ。

このコードは行をシャッフルすることで、パンチカードの落下をシミュレーションする。
そして自分自身を落としても（シャッフルしても）動く。
なんなら、順番を変えたら違う意味で動くようにも書けたので書いた。

実際にシャッフルで所望の挙動を得るのは大変なので、ちょっと便利な工夫がされている。

* `sort westley.c`をしたら、行の順序はいじらずにパンチカード風表示をするだけのコードが得られる
* `sort -b westley.c`をしたら、行の反転だけをするコードが得られる（`-b`は行頭の空白を無視してソートするオプション）

パンチカードはASCIIではなく[EBCDIC](https://ja.wikipedia.org/wiki/EBCDIC)という古い文字コードで表現される。
EBCDICでは一部の文字（`"^[]{}\"`など）が使えないので、コードはこれらを避けて書かれている。
そのために[トライグラフ](https://ja.wikipedia.org/wiki/%E3%83%88%E3%83%A9%E3%82%A4%E3%82%B0%E3%83%A9%E3%83%95)を多用しており、`gcc -ansi`か`gcc -trigraphs`でないとビルドできない。
`/* {   /KC 0000 K  } */`という謎のコメントは、EBCDICでパンチカードにしたときに`(-:`になるパターン。

```
$ ./tmp < westley.c
...
 _________________________________________________________________________________
/                          /* {   /KC 0000 K  } */                               |
|                             [     [         [                                  |
|                           [ [    [       [  [ [                                |
|                          [  [   [   [[[[    [  [                               |
|                          [  [   [           [  [                               |
|                             [    [       [  [                                  |
|                             [     [         [                                  |
|                           [ [               [ [                                |
|                             [               [                                  |
|                             [               [                                  |
|                             [               [                                  |
|                           [ [               [ [                                |
|                             [               [                                  |
|________________________________________________________________________________|
...
```

賞名の[位置独立コード](https://ja.wikipedia.org/wiki/%E4%BD%8D%E7%BD%AE%E7%8B%AC%E7%AB%8B%E3%82%B3%E3%83%BC%E3%83%89)は、各行をどこに置いても動くことを指しているが、本来はどのアドレスに配置されても動く機械語のことを言う。

実に神がかっている。これは、westley最後の作品（2020年現在）。次の作品がみたい。
