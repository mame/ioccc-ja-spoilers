---
id: 2005/anon
year: 2005
order: 2
authors: "Anonymous_2005"
orig_url: "https://www.ioccc.org/2005/anon/anon.c"
hint_url: "https://www.ioccc.org/2005/anon/hint.text"
title: "IOCCC 2005: Best 3D puzzle"
award_ja: "最高の3Dパズル"
---

## 動作

15パズルの任意サイズ化＋3D対応。

次のように起動すると普通の15パズルになる。

```
$ gcc -o anon anon.c

$ ./anon 4 4
```

```
 15   7  13   2
 10   3   1   5
 ##   8  11   6
 14   9   4  12
```

`##`が空きマス。<kbd>j</kbd>と<kbd>l</kbd>で空きマスを左右に動かし、<kbd>i</kbd>と<kbd>k</kbd>で上下に動かす。

次のように起動すると3次元化する。

```
$ ./anon 3 3 3
```

```
    7    11     1
  12     9    22
 25    23     4

   18    17     8
   6    14    26
  2    20    13

   10    24    21
  15    19     5
 ##    16     3
```

操作方法は2D版に加え、<kbd>o</kbd>で奥方向に動かし、<kbd>n</kbd>で手前方向に動かす。

## 解説

難読化の一番のポイントとされているのは、変数宣言も`malloc`もせずに動いていること。
`argc`と`argv`だけでどうにかしているわけでもない。
どうしているかというと、`main`を再帰させることでスタックを伸ばし、その連続領域をメモリとして使っている。
スタックが伸びる方向は環境によって違いがあるが、検出して適切に扱っているとのこと。

確保された領域は、フレームポインタやリターンアドレスも遠慮なく書き潰されるので、スタックは破壊される。
そのため`main`関数は正常に`return`はできないので、終了するときは`exit()`を使っている。

生成されるパズルは解けないこともある。
初期版はパリティチェックしていたが、IOCCCのサイズ制限のために除去したとのこと。

ゲーム中毒防止のため（？）、また、解けないパズルに無限の時間を使ってしまわないようにするため、長く操作をしているとそのうち異常終了するとのこと。
操作のたびに`main`を再帰することにより、そのうちスタックオーバーフローするという仕様になっている。

ia64でポインタを格納するために`int`ではなく`long`にした、という記述があり、近代になってきた感がある。

マクロを使った難読化もいろいろ行われている。
多くのマクロはサブルーチン的に使われているので、単純にプリプロセスで展開してもわかりやすくならない。
`main`関数が1つの巨大な`return`文になっているので、indentコマンドをかけるのもほとんど無力。
hint.textに各マクロやデータ構造の詳細な解説があるので、興味があれば参照するとよい。

